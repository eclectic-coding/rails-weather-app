<h1>Weather Search</h1>

<div data-controller="weather-search">
  <form action="/weather" method="get" data-weather-search-target="form">
    <% current_mode = params[:mode].presence || (
      if @search_info.present?
        @search_info[:type] == :city_state ? 'city_state' : 'zip'
      else
        'zip'
      end) %>
    <fieldset>
      <legend>Search by</legend>
      <label>
        <input type="radio" name="mode" value="zip" <%= 'checked' if current_mode == 'zip' %> data-action="weather-search#modeChange">
        ZIP code
      </label>
      <label>
        <input type="radio" name="mode" value="city_state" <%= 'checked' if current_mode == 'city_state' %> data-action="weather-search#modeChange">
        City / State (US only)
      </label>
    </fieldset>

    <div data-weather-search-target="zipFields">
      <label for="zip">ZIP code</label>
      <input id="zip" name="zip" data-weather-search-target="zip" type="text" pattern="\d{5}" maxlength="5" inputmode="numeric" value="<%= h params[:zip] %>">
    </div>

    <div data-weather-search-target="cityStateFields" style="display:none; margin-top: 8px;">
      <label for="city">City</label>
      <input id="city" name="city" data-weather-search-target="city" type="text" value="<%= h params[:city] %>">

      <label for="state">State (2-letter code)</label>
      <input id="state" name="state" data-weather-search-target="state" type="text" maxlength="2" style="text-transform:uppercase" value="<%= h params[:state] %>">
    </div>

    <div style="margin-top: 12px;">
      <button type="submit">Search</button>
    </div>
  </form>

  <% if @error.present? %>
    <p style="color: red;"><%= @error %></p>
  <% end %>

  <% if @api_error.present? %>
    <div style="margin-top: 16px; padding: 8px; border: 1px solid #f5c2c7; background: #fff0f0; color: #7a1f1f;">
      <strong>API error:</strong>
      <p><%= h @api_error %></p>
    </div>
  <% end %>

  <%# Render the extracted result partial - it handles both a weather_result and a search_info fallback %>
  <%= render partial: 'weather/result', locals: { weather_result: @weather_result, search_info: @search_info, cached: @cached, cached_at: @cached_at } %>
</div>
