<div class="row">
  <div class="col-10 col-md-8 mx-auto">
    <h1>Weather Search</h1>

    <div data-controller="weather-search">
      <%# Use Rails form helpers for a GET form to /weather and keep Stimulus target on the form %>
      <% current_mode = params[:mode].presence || (
        if @search_info.present?
          @search_info[:type] == :city_state ? 'city_state' : 'zip'
        else
          'zip'
        end) %>

      <%= form_with url: '/weather', method: :get, local: true, data: { 'weather-search-target': 'form' }, html: { class: 'needs-validation', novalidate: true } do %>
        <fieldset class="mb-3">
          <legend class="col-form-label">Search by</legend>

          <div class="form-check form-check-inline">
            <%= radio_button_tag 'mode', 'zip', current_mode == 'zip', class: 'form-check-input', id: 'mode_zip', data: { action: 'weather-search#modeChange' } %>
            <%= label_tag 'mode_zip', 'ZIP code', class: 'form-check-label' %>
          </div>

          <div class="form-check form-check-inline">
            <%= radio_button_tag 'mode', 'city_state', current_mode == 'city_state', class: 'form-check-input', id: 'mode_city_state', data: { action: 'weather-search#modeChange' } %>
            <%= label_tag 'mode_city_state', 'City / State (US only)', class: 'form-check-label' %>
          </div>
        </fieldset>

        <div data-weather-search-target="zipFields" class="mb-3">
          <%= label_tag :zip, 'ZIP code', class: 'form-label' %>

          <div class="row">
            <div class="col-12 col-md-4">
              <%= text_field_tag :zip, params[:zip], id: 'zip', pattern: '\\d{5}', maxlength: 5, inputmode: 'numeric', placeholder: 'e.g. 90210', class: 'form-control', data: { 'weather-search-target': 'zip' } %>
              <div class="invalid-feedback">Please enter a 5-digit ZIP code.</div>
            </div>
          </div>
        </div>

        <div data-weather-search-target="cityStateFields" class="mb-3 d-none mt-2">
          <div class="row g-2">
            <div class="col-12 col-md-8">
              <%= label_tag :city, 'City', class: 'form-label' %>
              <%= text_field_tag :city, params[:city], id: 'city', class: 'form-control', data: { 'weather-search-target': 'city' } %>
            </div>

            <div class="col-12 col-md-4 col-lg-3">
              <%= label_tag :state, 'State (2-letter code)', class: 'form-label' %>
              <%= text_field_tag :state, params[:state], id: 'state', maxlength: 2, class: 'form-control text-uppercase', data: { 'weather-search-target': 'state' } %>
            </div>
          </div>
        </div>

        <div class="mt-3">
          <%= submit_tag 'Search', class: 'btn btn-primary' %>
        </div>
      <% end %>

      <% if @error.present? %>
        <div class="alert alert-danger mt-3" role="alert"><%= @error %></div>
      <% end %>

      <% if @api_error.present? %>
        <div class="alert alert-warning mt-3" role="alert">
          <strong>API error:</strong>
          <p class="mb-0"><%= h @api_error %></p>
        </div>
      <% end %>

      <%# Render the extracted result partial - it handles both a weather_result and a search_info fallback %>
      <%= render partial: 'weather/result', locals: { weather_result: @weather_result, search_info: @search_info, cached: @cached, cached_at: @cached_at } %>
    </div>
  </div>
</div>